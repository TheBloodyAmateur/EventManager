name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - closed  # Runs when a PR is merged

permissions:
  contents: write  # Required for GitHub Pages deployment

jobs:
  restrict_push:
    runs-on: ubuntu-latest
    steps:
      - name: Check if user is allowed
        run: |
          if [[ "${{ github.actor }}" != "TheBloodyAmateur" ]]; then
            echo "❌ Only TheBloodyAmateur can push to main!"
            exit 1
          fi
  build:
    needs: restrict_push
    runs-on: ubuntu-latest
    outputs:
      IS_RELEASE: ${{ steps.check_release.outputs.IS_RELEASE }}
      TAG_VERSION: ${{ steps.check_release.outputs.TAG_VERSION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant execute permission for Gradle
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build --stacktrace

      - name: Run Tests
        run: ./gradlew test --stacktrace

      - name: Check for release trigger
        id: check_release
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Last commit message: $COMMIT_MSG"

          if [[ "$COMMIT_MSG" =~ ^(Release|release):\ v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            TAG_VERSION=${BASH_REMATCH[2]}
            echo "New release tag detected: $TAG_VERSION"
            echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_ENV
            echo "IS_RELEASE=true" >> $GITHUB_ENV
            echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_OUTPUT
            echo "IS_RELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "No release tag detected."
            echo "IS_RELEASE=false" >> $GITHUB_ENV
            echo "IS_RELEASE=false" >> $GITHUB_OUTPUT
          fi

  deploy_javadoc:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Generate Javadoc
        run: ./gradlew javadoc

      - name: Deploy Javadoc to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: build/docs/javadoc
          clean: true

  generate_release_notes:
    needs: build
    if: ${{ needs.build.outputs.IS_RELEASE == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ env.release_notes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate release notes
        id: generate_notes
        run: |
          COMMITS=$(git log --oneline)
          ALLOWED_LABELS="^(feat|fix|docs|chore|improvement|security):"
          NOTES=""

          for commit in $COMMITS; do
            if [[ "$commit" =~ $ALLOWED_LABELS ]]; then
              LABEL=$(echo "$commit" | sed -E 's/^(.*?):.*/\1/')
              MESSAGE=$(echo "$commit" | sed -E 's/^(.*?): (.*)/\2/')
              NOTES="${NOTES}\n- **${LABEL}**: ${MESSAGE}"
            fi
          done

          if [ -z "$NOTES" ]; then
            NOTES="No notable changes in this release."
          fi

          echo "Release notes generated:"
          echo "$NOTES"

          echo "release_notes<<EOF" >> $GITHUB_ENV
          echo "$NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
  

  generate_release_tag:
    needs: [ build, generate_release_notes ]
    if: ${{ needs.build.outputs.IS_RELEASE == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git User
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Check if tag already exists
        id: check_tag
        run: |
          git fetch --tags
          if git rev-parse "v${{ needs.build.outputs.TAG_VERSION }}" >/dev/null 2>&1; then
            echo "Tag v${{ needs.build.outputs.TAG_VERSION }} already exists."
            echo "TAG_EXISTS=true" >> $GITHUB_ENV
          else
            echo "Tag v${{ needs.build.outputs.TAG_VERSION }} does not exist. Creating it now."
            echo "TAG_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Create Git tag for release
        if: ${{ env.TAG_EXISTS == 'false' }}
        run: |
          git tag -a "v${{ needs.build.outputs.TAG_VERSION }}" -m "Release version ${{ needs.build.outputs.TAG_VERSION }}"
          git push origin "v${{ needs.build.outputs.TAG_VERSION }}"

      - name: Debug Received Release Notes
        run: |
          echo "Received Release Notes in generate_release_tag:"
          echo "${{ needs.generate_release_notes.outputs.release_notes }}"

      - name: Create a GitHub release with release notes
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ needs.build.outputs.TAG_VERSION }}"
          files: build/libs/*.jar
          body: ${{ needs.generate_release_notes.outputs.release_notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trigger_jitpack_build:
    needs: generate_release_tag
    if: ${{ needs.build.outputs.IS_RELEASE == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Fetch JitPack Build Log
        run: |
          TAG_VERSION="${{ needs.build.outputs.TAG_VERSION }}"
          echo "Checking JitPack build for version: v$TAG_VERSION"
          echo "Build Log URL: https://jitpack.io/com/github/TheBloodyAmateur/EventManager/v$TAG_VERSION/build.log"

          RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://jitpack.io/com/github/TheBloodyAmateur/EventManager/v$TAG_VERSION/build.log")

          if [[ "$RESPONSE_CODE" -ne 200 ]]; then
            echo "❌ JitPack build log not found. The version might not be available yet."
            exit 1
          else
            echo "✅ JitPack build log available!"
          fi